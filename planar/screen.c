#include "screen.h"
#include "bitplanes.h"
#include <clib/exec_protos.h>
#include <clib/graphics_protos.h>
#include "ahpc_registers.h"
#include "init.h"

extern struct Custom custom;

UWORD __chip copperlist[] = {

    COP_MOVE(FMODE,   0), // set fetch mode = 0 (slow fetch mode for AGA compatibility)

    COP_MOVE(SPR0PTH, 0), COP_MOVE(SPR0PTL, 0),     // Sprites
    COP_MOVE(SPR1PTH, 0), COP_MOVE(SPR1PTL, 0),
    COP_MOVE(SPR2PTH, 0), COP_MOVE(SPR2PTL, 0),
    COP_MOVE(SPR3PTH, 0), COP_MOVE(SPR3PTL, 0),
    COP_MOVE(SPR4PTH, 0), COP_MOVE(SPR4PTL, 0),
    COP_MOVE(SPR5PTH, 0), COP_MOVE(SPR5PTL, 0),
    COP_MOVE(SPR6PTH, 0), COP_MOVE(SPR6PTL, 0),
    COP_MOVE(SPR7PTH, 0), COP_MOVE(SPR7PTL, 0),

    COP_MOVE(DDFSTRT, DDFSTRT_VALUE),
    COP_MOVE(DDFSTOP, DDFSTOP_VALUE),
    COP_MOVE(DIWSTRT, DIWSTRT_VALUE),
    COP_MOVE(DIWSTOP, DIWSTOP_VALUE_PAL),
    COP_MOVE(BPLCON0, BPLCON0_5BPP_COMPOSITE_COLOR),        // defaults to 5bpp no dual playfield

    // Bitplane modulos, interleaved, quindi 40 byte * 5-1 bitplane
    COP_MOVE(BPL1MOD, 40*4),
    COP_MOVE(BPL2MOD, 40*4),
    // Bitplane pointers.
    COP_MOVE(BPL1PTH, 0),
    COP_MOVE(BPL1PTL, 0),
    COP_MOVE(BPL2PTH, 0),
    COP_MOVE(BPL2PTL, 0),
    COP_MOVE(BPL3PTH, 0),
    COP_MOVE(BPL3PTL, 0),
    COP_MOVE(BPL4PTH, 0),
    COP_MOVE(BPL4PTL, 0),
    COP_MOVE(BPL5PTH, 0),
    COP_MOVE(BPL5PTL, 0),
    COP_MOVE(BPL6PTH, 0),
    COP_MOVE(BPL6PTL, 0),
    COP_MOVE(BPL7PTH, 0),
    COP_MOVE(BPL7PTL, 0),
    COP_MOVE(BPL8PTH, 0),
    COP_MOVE(BPL8PTL, 0),

// Palette ECS
	/* 0x0180,0x0000,0x0182,0x0aaa,0x0184,0x0e00,0x0186,0x0a00,
	0x0188,0x0d80,0x018a,0x0fe0,0x018c,0x08f0,0x018e,0x0080,
	0x0190,0x00b6,0x0192,0x00dd,0x0194,0x00af,0x0196,0x007c,
	0x0198,0x000f,0x019a,0x070f,0x019c,0x0c0e,0x019e,0x0c08,
	0x01a0,0x0620,0x01a2,0x00cf,0x01a4,0x006c,0x01a6,0x0029,
	0x01a8,0x0333,0x01aa,0x0444,0x01ac,0x0555,0x01ae,0x0666,
	0x01b0,0x0777,0x01b2,0x0888,0x01b4,0x0999,0x01b6,0x0aaa,
	0x01b8,0x0ccc,0x01ba,0x0ddd,0x01bc,0x0eee,0x01be,0x0fff, */

	

// Palette AGA
 	0x0106,0x0000,0x0180,0x0345,0x0182,0x0abc,0x0184,0x08ac,
	0x0186,0x0dcc,0x0188,0x0578,0x018a,0x0fff,0x018c,0x0dff,
	0x018e,0x0000,0x0190,0x0112,0x0192,0x0233,0x0194,0x0457,
	0x0196,0x078a,0x0198,0x08bd,0x019a,0x09ce,0x019c,0x0bde,
	0x019e,0x0cef,0x01a0,0x0eee,0x01a2,0x0ddd,0x01a4,0x0ddd,
	0x01a6,0x0ccc,0x01a8,0x0bbb,0x01aa,0x0aaa,0x01ac,0x0999,
	0x01ae,0x0888,0x01b0,0x0777,0x01b2,0x0777,0x01b4,0x0666,
	0x01b6,0x0555,0x01b8,0x0444,0x01ba,0x0333,0x01bc,0x0222,
	0x01be,0x0222,0x0106,0x0200,0x0180,0x0daa,0x0182,0x0cef,
	0x0184,0x0860,0x0186,0x01c8,0x0188,0x0c17,0x018a,0x00aa,
	0x018c,0x023a,0x018e,0x078c,0x0190,0x05c3,0x0192,0x084f,
	0x0194,0x08c2,0x0196,0x01d6,0x0198,0x06af,0x019a,0x079e,
	0x019c,0x017c,0x019e,0x0255,0x01a0,0x0fff,0x01a2,0x0fff,
	0x01a4,0x0333,0x01a6,0x0333,0x01a8,0x0777,0x01aa,0x0bbb,
	0x01ac,0x0bbb,0x01ae,0x0fff,0x01b0,0x0fff,0x01b2,0x0333,
	0x01b4,0x0777,0x01b6,0x0777,0x01b8,0x0bbb,0x01ba,0x0bbb,
	0x01bc,0x0fff,0x01be,0x0333,0x0106,0x2000,0x0180,0x0000,
	0x0182,0x0aaa,0x0184,0x0555,0x0186,0x0fff,0x0188,0x0f4a,
	0x018a,0x0808,0x018c,0x0e00,0x018e,0x0620,0x0190,0x0f60,
	0x0192,0x0fa8,0x0194,0x0fe0,0x0196,0x0080,0x0198,0x00d0,
	0x019a,0x00cc,0x019c,0x006f,0x019e,0x000a,0x01a0,0x0fdd,
	0x01a2,0x0fbb,0x01a4,0x0f99,0x01a6,0x0f77,0x01a8,0x0f55,
	0x01aa,0x0f44,0x01ac,0x0f22,0x01ae,0x0f00,0x01b0,0x0fa5,
	0x01b2,0x0f94,0x01b4,0x0f82,0x01b6,0x0f70,0x01b8,0x0e60,
	0x01ba,0x0c60,0x01bc,0x0b50,0x01be,0x0940,0x0106,0x2200,
	0x0180,0x0000,0x0182,0x0000,0x0184,0x0555,0x0186,0x0fff,
	0x0188,0x0f4a,0x018a,0x0808,0x018c,0x0e00,0x018e,0x0620,
	0x0190,0x0f60,0x0192,0x0fa8,0x0194,0x0fe0,0x0196,0x0080,
	0x0198,0x00d0,0x019a,0x00cc,0x019c,0x006f,0x019e,0x000a,
	0x01a0,0x0faa,0x01a2,0x0faa,0x01a4,0x0fff,0x01a6,0x0fff,
	0x01a8,0x0fff,0x01aa,0x0f00,0x01ac,0x0f00,0x01ae,0x0f00,
	0x01b0,0x0c8c,0x01b2,0x0c80,0x01b4,0x0c80,0x01b6,0x0c80,
	0x01b8,0x04c0,0x01ba,0x0c00,0x01bc,0x0440,0x01be,0x0cc0,
	0x0106,0x4000,0x0180,0x0ffd,0x0182,0x0ffb,0x0184,0x0ff9,
	0x0186,0x0ff7,0x0188,0x0ff5,0x018a,0x0ff4,0x018c,0x0ff2,
	0x018e,0x0ff0,0x0190,0x0ed0,0x0192,0x0cc0,0x0194,0x0ba0,
	0x0196,0x0990,0x0198,0x0880,0x019a,0x0760,0x019c,0x0550,
	0x019e,0x0440,0x01a0,0x0df5,0x01a2,0x0cf4,0x01a4,0x0bf2,
	0x01a6,0x0af0,0x01a8,0x09e0,0x01aa,0x08c0,0x01ac,0x07b0,
	0x01ae,0x0690,0x01b0,0x0dfd,0x01b2,0x0bfb,0x01b4,0x09f9,
	0x01b6,0x08f7,0x01b8,0x06f5,0x01ba,0x04f4,0x01bc,0x02f2,
	0x01be,0x00f0,0x0106,0x4200,0x0180,0x0cc8,0x0182,0x0cc8,
	0x0184,0x0ccc,0x0186,0x0ccc,0x0188,0x0c8c,0x018a,0x0c40,
	0x018c,0x0c40,0x018e,0x0c40,0x0190,0x0480,0x0192,0x0c40,
	0x0194,0x04c0,0x0196,0x0cc0,0x0198,0x0440,0x019a,0x00c0,
	0x019c,0x0840,0x019e,0x0000,0x01a0,0x00cc,0x01a2,0x04c0,
	0x01a4,0x04c0,0x01a6,0x00c0,0x01a8,0x0040,0x01aa,0x00c0,
	0x01ac,0x0440,0x01ae,0x00c0,0x01b0,0x08c8,0x01b2,0x0cc8,
	0x01b4,0x0ccc,0x01b6,0x00cc,0x01b8,0x00cc,0x01ba,0x00c0,
	0x01bc,0x00c0,0x01be,0x00c0,0x0106,0x6000,0x0180,0x00f0,
	0x0182,0x00e0,0x0184,0x00e0,0x0186,0x00d0,0x0188,0x00c0,
	0x018a,0x00b0,0x018c,0x00b0,0x018e,0x00a0,0x0190,0x0090,
	0x0192,0x0080,0x0194,0x0070,0x0196,0x0070,0x0198,0x0060,
	0x019a,0x0050,0x019c,0x0040,0x019e,0x0040,0x01a0,0x0dff,
	0x01a2,0x0bff,0x01a4,0x09ff,0x01a6,0x07ff,0x01a8,0x05ff,
	0x01aa,0x04ff,0x01ac,0x02ff,0x01ae,0x00ff,0x01b0,0x00ee,
	0x01b2,0x00cc,0x01b4,0x00bb,0x01b6,0x0099,0x01b8,0x0088,
	0x01ba,0x0077,0x01bc,0x0055,0x01be,0x0044,0x0106,0x6200,
	0x0180,0x00f0,0x0182,0x00f0,0x0184,0x0030,0x0186,0x0070,
	0x0188,0x07b0,0x018a,0x07f0,0x018c,0x0730,0x018e,0x0770,
	0x0190,0x07b0,0x0192,0x07b0,0x0194,0x07f0,0x0196,0x0730,
	0x0198,0x0770,0x019a,0x07b0,0x019c,0x07f0,0x019e,0x0400,
	0x01a0,0x0aff,0x01a2,0x08cc,0x01a4,0x0ccc,0x01a6,0x0cc8,
	0x01a8,0x0ccc,0x01aa,0x00cc,0x01ac,0x00cc,0x01ae,0x00cc,
	0x01b0,0x0044,0x01b2,0x00cc,0x01b4,0x0044,0x01b6,0x00cc,
	0x01b8,0x0044,0x01ba,0x0000,0x01bc,0x0088,0x01be,0x0000,
	0x0106,0x8000,0x0180,0x05bf,0x0182,0x04bf,0x0184,0x02af,
	0x0186,0x009f,0x0188,0x008e,0x018a,0x007c,0x018c,0x006b,
	0x018e,0x0059,0x0190,0x0ddf,0x0192,0x0bbf,0x0194,0x099f,
	0x0196,0x078f,0x0198,0x056f,0x019a,0x044f,0x019c,0x022f,
	0x019e,0x000f,0x01a0,0x000f,0x01a2,0x000e,0x01a4,0x000e,
	0x01a6,0x000d,0x01a8,0x000c,0x01aa,0x000b,0x01ac,0x000b,
	0x01ae,0x000a,0x01b0,0x0009,0x01b2,0x0008,0x01b4,0x0007,
	0x01b6,0x0007,0x01b8,0x0006,0x01ba,0x0005,0x01bc,0x0004,
	0x01be,0x0004,0x0106,0x8200,0x0180,0x0ccc,0x0182,0x000c,
	0x0184,0x008c,0x0186,0x00cc,0x0188,0x00c4,0x018a,0x00cc,
	0x018c,0x00c4,0x018e,0x00cc,0x0190,0x0aaf,0x0192,0x0aff,
	0x0194,0x0fff,0x0196,0x0f0f,0x0198,0x0f0f,0x019a,0x000f,
	0x019c,0x005f,0x019e,0x005f,0x01a0,0x000f,0x01a2,0x000f,
	0x01a4,0x0003,0x01a6,0x0007,0x01a8,0x000b,0x01aa,0x000f,
	0x01ac,0x0003,0x01ae,0x0007,0x01b0,0x000b,0x01b2,0x000b,
	0x01b4,0x000f,0x01b6,0x0003,0x01b8,0x0007,0x01ba,0x000b,
	0x01bc,0x000f,0x01be,0x0000,0x0106,0xa000,0x0180,0x0fdf,
	0x0182,0x0ebf,0x0184,0x0d9f,0x0186,0x0d7f,0x0188,0x0c5f,
	0x018a,0x0b4f,0x018c,0x0b2f,0x018e,0x0a0f,0x0190,0x090e,
	0x0192,0x080c,0x0194,0x070b,0x0196,0x0609,0x0198,0x0508,
	0x019a,0x0407,0x019c,0x0305,0x019e,0x0204,0x01a0,0x0fdf,
	0x01a2,0x0fbf,0x01a4,0x0f9f,0x01a6,0x0f7f,0x01a8,0x0f5f,
	0x01aa,0x0f4f,0x01ac,0x0f2f,0x01ae,0x0f0f,0x01b0,0x0e0e,
	0x01b2,0x0c0c,0x01b4,0x0b0b,0x01b6,0x0909,0x01b8,0x0808,
	0x01ba,0x0607,0x01bc,0x0505,0x01be,0x0404,0x0106,0xa200,
	0x0180,0x00af,0x0182,0x05af,0x0184,0x0aff,0x0186,0x00ff,
	0x0188,0x0aff,0x018a,0x0f0f,0x018c,0x050f,0x018e,0x0a0f,
	0x0190,0x0a05,0x0192,0x000f,0x0194,0x0505,0x0196,0x000f,
	0x0198,0x0005,0x019a,0x0500,0x019c,0x050a,0x019e,0x0a00,
	0x01a0,0x0faf,0x01a2,0x0faf,0x01a4,0x0fff,0x01a6,0x0fff,
	0x01a8,0x0fff,0x01aa,0x0f0f,0x01ac,0x0f0f,0x01ae,0x0f0f,
	0x01b0,0x0005,0x01b2,0x0a0f,0x01b4,0x0505,0x01b6,0x0f0f,
	0x01b8,0x0505,0x01ba,0x0f00,0x01bc,0x0a0a,0x01be,0x0000,
	0x0106,0xc000,0x0180,0x0fed,0x0182,0x0fdd,0x0184,0x0fdc,
	0x0186,0x0ecb,0x0188,0x0eba,0x018a,0x0db9,0x018c,0x0da9,
	0x018e,0x0c98,0x0190,0x0c98,0x0192,0x0b87,0x0194,0x0b76,
	0x0196,0x0a76,0x0198,0x0a65,0x019a,0x0a65,0x019c,0x0954,
	0x019e,0x0954,0x01a0,0x0843,0x01a2,0x0833,0x01a4,0x0732,
	0x01a6,0x0732,0x01a8,0x0722,0x01aa,0x0621,0x01ac,0x0611,
	0x01ae,0x0511,0x01b0,0x0511,0x01b2,0x0410,0x01b4,0x0400,
	0x01b6,0x0300,0x01b8,0x0300,0x01ba,0x0200,0x01bc,0x0200,
	0x01be,0x0200,0x0106,0xc200,0x0180,0x0f9e,0x0182,0x07d0,
	0x0184,0x0013,0x0186,0x0977,0x0188,0x01aa,0x018a,0x0a0e,
	0x018c,0x0344,0x018e,0x0cb9,0x0190,0x0500,0x0192,0x0e66,
	0x0194,0x06cb,0x0196,0x0f33,0x0198,0x08ba,0x019a,0x0112,
	0x019c,0x0a9a,0x019e,0x0303,0x01a0,0x0b8b,0x01a2,0x04f4,
	0x01a4,0x0e9e,0x01a6,0x0718,0x01a8,0x00c3,0x01aa,0x096d,
	0x01ac,0x01f8,0x01ae,0x0ab4,0x01b0,0x0350,0x01b2,0x0c1d,
	0x01b4,0x05c9,0x01b6,0x0e97,0x01b8,0x0654,0x01ba,0x0f32,
	0x01bc,0x0811,0x01be,0x0100,0x0106,0xe000,0x0180,0x0f55,
	0x0182,0x0fb8,0x0184,0x0ff8,0x0186,0x08f8,0x0188,0x08ff,
	0x018a,0x088f,0x018c,0x0b8f,0x018e,0x0f8f,0x0190,0x0c22,
	0x0192,0x0c42,0x0194,0x0c72,0x0196,0x0c92,0x0198,0x0cc2,
	0x019a,0x09c2,0x019c,0x07c2,0x019e,0x04c2,0x01a0,0x02c3,
	0x01a2,0x02c5,0x01a4,0x02c8,0x01a6,0x02cb,0x01a8,0x02ac,
	0x01aa,0x027c,0x01ac,0x025c,0x01ae,0x022c,0x01b0,0x052c,
	0x01b2,0x082c,0x01b4,0x0b2c,0x01b6,0x0c2a,0x01b8,0x0c28,
	0x01ba,0x0c25,0x01bc,0x0c22,0x01be,0x0fff,0x0106,0xe200,
	0x0180,0x0f88,0x0182,0x0fe0,0x0184,0x0fe2,0x0186,0x02f4,
	0x0188,0x00ff,0x018a,0x000f,0x018c,0x0f0f,0x018e,0x0e0f,
	0x0190,0x07bb,0x0192,0x07fb,0x0194,0x077b,0x0196,0x07fb,
	0x0198,0x077b,0x019a,0x0f7b,0x019c,0x077b,0x019e,0x0f7b,
	0x01a0,0x0b73,0x01a2,0x0b7f,0x01a4,0x0b7b,0x01a6,0x0b77,
	0x01a8,0x0bb7,0x01aa,0x0bf7,0x01ac,0x0b37,0x01ae,0x0fb7,
	0x01b0,0x0bb7,0x01b2,0x07b7,0x01b4,0x03b7,0x01b6,0x07bf,
	0x01b8,0x07b3,0x01ba,0x07b7,0x01bc,0x07bb,0x01be,0x0fff,


	// Palette playfield 1

	/* 0x0106,0x0000,0x0180,0x0345,0x0182,0x0abc,0x0184,0x08ac,
	0x0186,0x0dcc,0x0188,0x0578,0x018a,0x0fff,0x018c,0x0dff,
	0x018e,0x0000,0x0190,0x0112,0x0192,0x0233,0x0194,0x0457,
	0x0196,0x078a,0x0198,0x08bd,0x019a,0x09ce,0x019c,0x0bde,
	0x019e,0x0cef,0x0106,0x0200,0x0180,0x0daa,0x0182,0x0cef,
	0x0184,0x0860,0x0186,0x01c8,0x0188,0x0c17,0x018a,0x00aa,
	0x018c,0x023a,0x018e,0x078c,0x0190,0x05c3,0x0192,0x084f,
	0x0194,0x08c2,0x0196,0x01d6,0x0198,0x06af,0x019a,0x079e,
	0x019c,0x017c,0x019e,0x0255, */

	0x0106,0x1000,		// Seleziono palette per dual playfield (BPLCON3) colori 16-31 
						// con i bit 10,11,12

	// CLXCON
	0x0098,0x0,
	// CLXCON2
	0x010e,0x0082,
	
	// Per collisione con colore 1 del PF2
	// CLXCON (098)
	// SSSSBBBBBBCCCCCC
	// 0000111111000010		0fc2

	// CLXCON2 (10e)
	// 0000000011000000		00c0

/*
    COP_MOVE(COLOR00, 0x000),
    0x7c07, 0xfffe,            // wait for 1/3 (0x07, 0x7c)
    COP_MOVE(COLOR00, 0xf00),
    0xda07, 0xfffe,            // wait for 2/3 (0x07, 0xda)
    COP_MOVE(COLOR00, 0xff0),
*/
    COP_WAIT_END
};

struct AmigaScreen screen;

void init_screen(UWORD   bytes_width,
    UWORD   height,
    UBYTE   depth,
    UBYTE   left_margin_bytes,
    UBYTE   right_margin_bytes,
    UBYTE   display_start_offset_bytes,
    BOOL    dual_playfield) {

        BOOL is_pal = init_display();

        
        screen.framebuffer_size = (bytes_width+left_margin_bytes+right_margin_bytes)*height*depth;

        screen.bitplanes = init_bitplanes(screen.framebuffer_size);
        screen.depth = depth;
        screen.left_margin_bytes = left_margin_bytes;
        screen.right_margin_bytes = right_margin_bytes;
        screen.display_start_offset_bytes = display_start_offset_bytes;
        screen.bytes_width = bytes_width;
        screen.row_size = (bytes_width + left_margin_bytes+right_margin_bytes);
		screen.dual_playfield = dual_playfield;

        //point_bitplanes(screen.bitplanes+display_start_offset_bytes,&copperlist[BPL1PTH_VALUE_IDX],screen.depth);

        // Set bplcon0 accordingly

        UWORD bplcon0 = 0x200;  // Defaults to enable color burst output signal, bit 9 of bplcon0
        
        // TODO: Gestire errore se > 8
        if (depth < 8) {
            bplcon0 |= depth << 12; // Sets bitplanes number
        } else {
            bplcon0 |= 0x10;         // Sets eight bitplanes
        }


        if (dual_playfield) {
            bplcon0 |= 0x400;   // Sets bit 10
        }


        copperlist[BPLCON0_VALUE_IDX] = bplcon0;
        
        // Set modulos for interleaved bitplanes
        UWORD modulo = 0x0;
		if (dual_playfield) {
			// TODO: modulo per caso specifico per DP 4+4, generalizzare
			modulo = (screen.row_size*(4 - 1))+left_margin_bytes+right_margin_bytes;
		} else {
			modulo = (screen.row_size*(depth - 1))+left_margin_bytes+right_margin_bytes;
		}
		
        

        copperlist[BPL1MOD_VALUE_IDX] = modulo;
        copperlist[BPL2MOD_VALUE_IDX] = modulo;

        custom.cop1lc = (ULONG) copperlist;

		WaitTOF();       // 2 WaitTOFs to wait for 1. long frame and
    	WaitTOF();       // 2. short frame copper lists to finish (if interlaced)

    }


/**
 * @brief Get the Faded Value OCS object
 * 
 * @param colorvalue 0x0RGB
 * @param frame 0-16
 * @return short 
 */
static UWORD getFadedValueOCS(UWORD colorvalue, USHORT frame) {

    short output = 0;

    short red = (colorvalue & 0x0F00);
    red *= frame;
    red >>= 4;
    red &= 0x0F00;
    output |= red;

    short green = (colorvalue & 0x00F0);
    green *= frame;
    green >>= 4;
    green &= 0x00F0;
    output |= green;

    short blue = (colorvalue & 0x000F);
    blue *= frame;
    blue >>= 4;
    blue &= 0x000F;
    output |= blue;

    return output;
}

/**
 * @brief Fade copperlist OCS palette values
 * 
 * @param rawPalette    Pointer to the first word of the rawPalette
 * @param copPalette    Pointer to the first color of copperlist palette
 * @param frame         Frame number: 0-16
 * @param colors        Number of colors to fade
 */
void fadePaletteOCS(UWORD* rawPalette,UWORD* copPalette,USHORT frame,USHORT colors) {
    for (int i = 0; i < colors; i++) {
        *copPalette = getFadedValueOCS(*rawPalette,frame);
        rawPalette++;
        copPalette+=2;
    }
}